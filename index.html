<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>eMMC Hacking 2018</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/moon.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

        <style>
.align {
    display: inline-block;
    margin: auto;
    text-align: left;
}

.reveal .slides section img.plain {
    background: none !important;
}

.reveal .slides .muted {
    color: #3d4646;
}
        </style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
                <section>
                    <h1><span style='text-transform:none;'>e</span>MMC Hacking</h1>
                    <h3 style='text-transform:none;'>(or: how I fixed long dead Galaxy S3 phones)</h3>
                    Oran Avraham<br />
                    January 2018
                </section>

                <section data-markdown data-timing="100">
                    <textarea data-template>
                        ## Who am I?
                        - Oran Avraham, 25
                        - Security researcher based in Israel
                        - Previously worked on openiBoot
                        - Found vulns in iPhone 3G(S) &amp; 4 baseband
                        - CTF player with Pasten
                        
                        https://oranav.me

                        Twitter: [@oranav](https://twitter.com/oranav)

                        <aside class="notes">
                            Medigate - no connection to my employer whatsoever
                        </aside>
                    </textarea>
                </section>

                <section data-markdown data-timing="20">
                    <textarea data-template>
                        ## Outline

                        1. Introduction
                        2. Samsung's eMMC patch
                        3. Obtain &amp; analyze the firmware
                        4. The bug
                        5. Resurrect dead phones
                    </textarea>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        ## Outline

                        1. Introduction
                        2. Samsung's eMMC patch  <!-- .element class="muted" -->
                        3. Obtain &amp; analyze the firmware  <!-- .element class="muted" -->
                        4. The bug  <!-- .element class="muted" -->
                        5. Resurrect dead phones  <!-- .element class="muted" -->
                    </textarea>
                </section>

                <section data-background="resources/deadparrot.jpg" data-state="fullscreen">
                    <h2 style="color:#fd4956">"Sudden Death Syndrome"</h2>
                </section>

                <section data-markdown data-timing="30">
                    <textarea data-template>
                        ## Story

                        Back in late 2012, Samsung Galaxy S3 (GT-I9300) phones started dying with no apparent reason

                        If you're lucky, phone boots into bootloader <!-- .element: class="fragment" -->

                        Otherwise, it's just bricked <!-- .element: class="fragment" -->

                        Lots of rants in forums <!-- .element: class="fragment" -->
                    </textarea>
                </section>

                <section data-timing="20">
                    <img class="stretch" src="resources/xdarant.png" />
                </section>

                <section data-timing="20">
                    <h2>Spoiler alert: they did</h2>
                    <span class="fragment">(Well, kind of...)</span>
                </section>

                <section data-background-image="resources/phone_diag.jpg">
                    <h1 style="color: #333333">Diagnosis</h1>
                </section>

                <section>
                    <h2>This is a working S3.</h2>
                    <img class="plain stretch" src="resources/s3-working.png" />
                </section>

                <section>
                    <h2>And this one is dead.</h2>
                    <img class="plain stretch" src="resources/s3-black.png" />
                </section>

                <section>
                    <h2>If you're lucky, you get this.</h2>
                    <img class="plain stretch" src="resources/s3-booting.png" />
                </section>

                <!--<section>
                    <h2>Or maybe this.</h2>
                    <img class="plain stretch" src="resources/s3-lpm.png" />
                </section>-->

                <!--<section>
                    <h2>You also get "download mode".</h2>
                    <img class="plain stretch" src="resources/s3-warning.png" />
                </section>-->

                <section>
                    <h2>You also get "download mode".</h2>
                    <img class="plain stretch" src="resources/s3-download.png" />
                </section>

                <section>
                    <h2>How S3 works (take 1)</h2>
                    <img class="plain" src="resources/new/schematic_1.svg" />

                    <aside class="notes">
                        eMMC - storage device
                    </aside>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        ## Outline

                        1. Introduction  <!-- .element class="muted" -->
                        2. Samsung's eMMC patch
                        3. Obtain &amp; analyze the firmware  <!-- .element class="muted" -->
                        4. The bug  <!-- .element class="muted" -->
                        5. Resurrect dead phones  <!-- .element class="muted" -->
                    </textarea>
                </section>

                <section data-timing="30">
                    <p>Then, samsung dropped a patch.</p>
                    <pre><code class="cpp" data-trim data-noescape>
    if (!strncmp(host-&gt;card-&gt;cid.prod_name, "VTU00M", 6) &amp;&amp;
        (host-&gt;card-&gt;cid.prod_rev == 0xf1) &amp;&amp;
        (mmc_start_movi_smart(host-&gt;card) == 0x2))
        host-&gt;card-&gt;movi_ops = 0x2;

    if (host-&gt;card-&gt;movi_ops == 0x2)
        mmc_start_movi_operation(host-&gt;card);
                    </code></pre>

                    <p><small>
                        <a href="https://github.com/CyanogenMod/android_kernel_samsung_smdk4412/commit/da8461692362317a8ffce4d4646953985fcf4e1d">mmc: Soft-patch MoviNAND VTU00M (16GB) eMMC failure</a><br />
                        <i>Linux/drivers/mmc/core/mmc.c</i>
                    </small></p>

                    <aside class="notes">
                        Samsung said this fixes the brick bug<br />
                        Don't talk about the patch yet! Mention only the MMC subsystem
                    </aside>
                </section>

                <section data-background="resources/eMMC.jpg">
                    <h2 style="color:#fd4956"><span style="text-transform:none;">e</span>MMC bus introduction</h2>
                </section>

                <section data-timing="60">
                    <h2>Embedded Multimedia Card</h2>
                    <p>eMMC is the de-facto standard storage for phones</p>
                    <p>SD card in BGA form</p>
                    <p>
                        <img src="resources/emmc-reader-1.jpg" height="150px" style="margin-right:20px" /><img src="resources/emmc-reader-2.jpg" height="150px" /><br/>
                        <small><i>HardKernel ODROID eMMC reader board</i></small>
                    </p>
                    <p>Essentially a NAND flash chip with convenient bus</p>

                    <aside class="notes">
                        eMMC contains the phone's software (Linux, Android) and the user's data (apps, photos, files etc.)
                    </aside>
                </section>

                <section data-timing="60">
                    <h2>eMMC commands</h2>
                    <div class="align">
                        <p>
                            64 commands (CMD0, CMD1, ..., CMD63), e.g.:
                            <small><ul>
                                <li>CMD17: READ_SINGLE_BLOCK</li>
                                <li>CMD24: WRITE_BLOCK</li>
                            </ul></small>
                        </p>
                        <p>32-bit argument</p>
                        <p class="fragment" data-fragment-index="0">Categorized into classes</p>
                        <p class="fragment" data-fragment-index="1">Class 8 contains an interesting set of commands</p>
                        <img src="resources/cmd60-63.png" class="fragment" data-fragment-index="1" />
                    </div>
                </section>

                <section data-timing="30">
                    <p>Back to the patch</p>
                    <pre><code class="cpp" data-trim data-noescape>
    if (!strncmp(host-&gt;card-&gt;cid.prod_name, "VTU00M", 6) &amp;&amp;
        (host-&gt;card-&gt;cid.prod_rev == 0xf1) &amp;&amp;
        (<!--<span class="fragment highlight-red">-->mmc_start_movi_smart<!--</span>-->(host-&gt;card) == 0x2))
        host-&gt;card-&gt;movi_ops = 0x2;

    if (host-&gt;card-&gt;movi_ops == 0x2)
        <span class="fragment highlight-red">mmc_start_movi_operation</span>(host-&gt;card);
                    </code></pre>

                    <p><small>
                        <a href="https://github.com/CyanogenMod/android_kernel_samsung_smdk4412/commit/da8461692362317a8ffce4d4646953985fcf4e1d">mmc: Soft-patch MoviNAND VTU00M (16GB) eMMC failure</a><br />
                        <i>Linux/drivers/mmc/core/mmc.c</i>
                    </small></p>

                    <aside class="notes">
                        VTU00M - model of chip<br/>
                        0xf1 - firmware revision<br/>
                    </aside>
                </section>

                <!--<section>
                    <pre><code class="cpp" data-trim data-noescape>
int mmc_start_movi_smart(struct mmc_card *card)
{
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_cmd</span>(card->host, 0xEFAC62EC);
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_cmd</span>(card->host, 0x0000CCEE);
    mmc_movi_read_req(card, (void *)data_buf, 0x1000, 1);
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_cmd</span>(card->host, 0xEFAC62EC);
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_cmd</span>(card->host, 0x00DECCEE);
    date = /* read from data_buf */;

    if (date !=  0x20120413) {
        err = -1;
        return err;
    }
    return 0x2;
} 
                    </code></pre>
                    <span class="fragment" data-fragment-index="0"><code>mmc_movi_cmd</code> is basically eMMC CMD62</span>
                </section>-->

                <section data-timing="90">
                    <pre style="width:100%"><code class="cpp" data-trim data-noescape>
int mmc_start_movi_operation(struct mmc_card *card)
{
    mmc_movi_cmd(card-&gt;host, 0xEFAC62EC);  <span class="fragment" data-fragment-index="2">// Enter secret backdoor mode</span>
    mmc_movi_cmd(card-&gt;host, 0x10210000);
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_erase_cmd</span>(card-&gt;host, 0x00040300, 0x4A03B510);  <span class="fragment" data-fragment-index="3">// 10 B5...</span>
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_erase_cmd</span>(card-&gt;host, 0x00040304, 0x28004790);
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_erase_cmd</span>(card-&gt;host, 0x00040308, 0xE7FED100);
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_erase_cmd</span>(card-&gt;host, 0x0004030C, 0x0000BD10);
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_erase_cmd</span>(card-&gt;host, 0x00040310, 0x00059D73);
    <span class="fragment highlight-red" data-fragment-index="0">mmc_movi_erase_cmd</span>(card-&gt;host, 0x0005C7EA, 0xFD89F7E3);
    mmc_movi_cmd(card-&gt;host, 0xEFAC62EC);  <span class="fragment" data-fragment-index="2">// Leave secret backdoor mode</span>
    mmc_movi_cmd(card-&gt;host, 0x00DECCEE);
} 
                    </code></pre>
                    <span class="fragment" data-fragment-index="1"><code>mmc_movi_cmd</code> is basically eMMC CMD62</span>

                    <aside class="notes" data-markdown>
                        1. Why is there an erase? Probably not really
                        2. movi_cmd is 62
                        3. Enter/leave secret backdoor
                        4. Consecutive numbers (first argument)
                        5. 10 B5

                        Thumb is an instruction set supported by ARM CPUs
                    </aside>
                </section>

                <section>
                    <h2>This is an eMMC...</h2>
                    <img src="resources/emmc-finger.jpg" />
                    <p>(next to a Thumb‚Ñ¢)</p>
                </section>

                <section data-timing="20">
                    <h2>How S3 works (take 2)</h2>
                    <img class="plain" src="resources/new/schematic_2.svg" />
                </section>

                <!--<section data-background="resources/morpheus.jpg">
                    <div class="stretch" style="-webkit-text-stroke:2px black">
                        <h2>WHAT IF I TOLD YOU</h2>
                        <h2 style="position:absolute;bottom:0;text-align:center;width:100%">THERE'S AN ARM INSIDE YOUR EMMC</h2>
                    </div>
                </section>-->

                <section data-timing="10">
                    <h2>patch.bin</h2>
                    <pre><code data-trim class="nohighlight" style="background:#3f3f3f">
                            10 B5 03 4A 90 47 00 28 00 D1 FE E7 10 BD 00 00 73 9D 05 00
                    </code></pre>
                </section>

                <section>
                    <h2>Lo and behold...</h2>
                    Here comes Samsung's patch.<br />
                    Please prepare your C skillz.
                </section>

                <section data-timing="30">
                    <pre><code class="cpp" data-trim data-noescape>
                    void sub_40300()
                    {
                        if (!sub_59D72())
                            while (1);
                    }
                    </code></pre>
                    <img src="resources/patch-disasm.png" height="400px" /><br />

                    <aside class="notes">
                        MOVE TO NEXT SLIDE BEFORE SAYING IT DOESN'T FIX ANYTHING
                    </aside>
                </section>

                <!--<section>
                    <h2>The other patch</h2>
                    <pre><code class="arm" data-trim>
                    0x5C7EA:    BL 0x40300
                    </code></pre>
                    Essentially a <code>jmp</code> to the first patch.
                </section>-->

                <section data-background="resources/fingerquotes.jpg" data-timing="30">
                    <div class="stretch" style="-webkit-text-stroke:2px black">
                        <h2>DEAR S3 CUSTOMERS</h2>
                        <h2 style="position:absolute;bottom:0;text-align:center;width:100%">WE "FIXED" IT</h2>
                    </div>

                    <aside class="notes">
                        Enter...
                    </aside>
                </section>

                <section data-timing="30">
                    <img src="resources/freeze.png" />

                    <blockquote class="fragment" style="width:100%" cite="https://forum.xda-developers.com/galaxy-s3/general/ultimate-galaxy-s3-unusual-freezing-t2133401">
                        Galaxy S3 <u>freezing</u> with <u>lockups</u>, <u>screen not responding</u>...<br />
                        and ending up with <u>unsual rebooting</u> and <u>bootlooping</u>...
                        Angry S3 users reporting this problem...<br />
                        Galaxy S3 keeps freezing every 5 mins (50+ freezes a day)<br />
                    </blockquote>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        ## Outline

                        1. Introduction  <!-- .element class="muted" -->
                        2. Samsung's eMMC patch  <!-- .element class="muted" -->
                        3. Obtain &amp; analyze the firmware
                        4. The bug  <!-- .element class="muted" -->
                        5. Resurrect dead phones  <!-- .element class="muted" -->
                    </textarea>
                </section>

                <section data-markdown data-timing="30">
                    <textarea data-template>
                        ## How to get a firmware?

                        1. Write code and try to probe your way out
                        2. Fuzz with different commands
                        3. Look for clues
                    </textarea>
                </section>

                <section data-timing="30">
                    So I Googled <code>0xEFAC62EC 0x10210000</code>
                    <pre class="fragment" data-fragment-index="0"><code class="cpp" data-trim>
    mmc_movi_vendor_cmd(card, 0xEFAC62EC);
    mmc_movi_vendor_cmd(card, 0x10210000);
    mmc_movi_erase_cmd(card, 0x0004DD9C, 0x000000FF);
    mmc_movi_vendor_cmd(card, 0xEFAC62EC);
    mmc_movi_vendor_cmd(card, 0x00DECCEE);
                    </code></pre>

                    <p class="fragment" data-fragment-index="0"><small>
                        <a href="https://android.googlesource.com/kernel/omap.git/+/90f1659b5a07c077d37dee4e089027f4e0b05ad9">[MMC] Patch the firmware of certain Samsung emmc parts to fix a bug</a><br />
                        <i>Linux/drivers/mmc/core/quirks.c</i><br />
                    </small></p>

                    <p class="fragment" data-fragment-index="1">But there was something else afterwards...</p>

                    <aside class="notes" data-markdown>
                        - Mention 0x10210000
                        - Mention 4DD9C
                    </aside>
                </section>

                <section data-timing="60">
                    <pre><code class="cpp" data-trim data-noescape>
#ifdef TEST_MMC_FW_PATCHING
    mmc_movi_vendor_cmd(card, 0xEFAC62EC);
    mmc_movi_vendor_cmd(card, 0x10210002);<span class="fragment">  // this is a 2</span>
    mmc_movi_erase_cmd(card, 0x0004DD9C, 0x00000004);
    <span class="fragment highlight-red">mmc_movi_read_cmd</span>(card, (u8 *)buffer);
    pr_debug("buffer[0] is 0x%x\n", *(u8 *)buffer);
    mmc_movi_vendor_cmd(card, 0xEFAC62EC);
    mmc_movi_vendor_cmd(card, 0x00DECCEE);
#endif
                    </code></pre>

                    <p class="fragment">Maybe this is Samsung's way of <i>reading the RAM</i>?</p>

                    <aside class="notes" data-markdown>
                        1. 10210002 instead of 10210000
                        2. Same address, but now with read command
                        3. Maybe method for reading the RAM?
                    </aside>
                </section>

                <!--<section data-background="resources/allthememe.jpg">
                </section>-->

                <section data-timing="20">
                    <pre><code class="cpp" data-trim>
for (unsigned addr = 0; addr &lt;= 0x80000; addr += 4) {
    mmc_movi_vendor_cmd(card, 0xEFAC62EC);
    mmc_movi_vendor_cmd(card, 0x10210002);
    mmc_movi_erase_cmd(card, addr, 0x00000004);
    mmc_movi_read_cmd(card, (u8 *)buffer);
    mmc_movi_vendor_cmd(card, 0xEFAC62EC);
    mmc_movi_vendor_cmd(card, 0x00DECCEE);

    write(outfd, buffer, 4);
}
                    </code></pre>

                    <aside class="notes">
                        Just loop over all possible addresses. This is what I got:
                    </aside>
                </section>

                <section data-background="resources/firmware.png" data-background-size="contain" data-background-color="#2d2d2d" data-timing="30">
                    <aside class="notes" data-markdown>
                        - Does look like a firmware!
                        - Names are my own
                    </aside>
                </section>

                <section data-timing="20">
                    <h2>Reversing the firmware?</h2>
                    The firmware contained <span class="fragment strike" data-fragment-index="0">strings!</span>
                    <span class="fragment" data-fragment-index="0">a string :-(</span></p>
                    <pre class="fragment"><code>"REL_ASSERT : (PC[%x] SP[%x] LR[%x])\n"</code></pre>
                </section>

                <!--<section data-timing="60">
                    <h2>Reversing the firmware</h2>

                    <p>CPU seems to be ARM Cortex-M3 (only Thumb!)</p>
                    <p class="fragment">Found <code>0xEFAC62EC</code></p>
                    <p class="fragment">Found a table of 64 entries - command handlers</p>
                    <p class="fragment">Worked my way to reverse most of the relevant code</p>
                    <p class="fragment">A <b>lot</b> of MMIO registers of unknown hardware</p>
                </section>-->

                <!--<section data-background="resources/firmware_cmdhandlers.png" data-background-size="contain" data-background-color="#2d2d2d">
                </section>-->

                <section data-background="resources/firmware_cmd62.png" data-background-size="contain" data-background-color="#2d2d2d" data-timing="30">
                </section>

                <section data-markdown>
                    <textarea data-template>
                        ## Outline

                        1. Introduction  <!-- .element class="muted" -->
                        2. Samsung's eMMC patch  <!-- .element class="muted" -->
                        3. Obtain &amp; analyze the firmware  <!-- .element class="muted" -->
                        4. The bug
                        5. Resurrect dead phones  <!-- .element class="muted" -->
                    </textarea>

                    <aside class="notes">
                        Before we talk about the bug, we must talk about...
                    </aside>
                </section>

                <section data-background="resources/chip_sketch.png">
                    <h2 style="color:#333;">eMMC Internals</h2>
                </section>

                <!--<section data-timing="10">
                    <h2>Normal storage</h2>

                    <ul>
                        <li>Read: read data</li>
                        <li>Write: write data</li>
                    </ul>
                </section>

                <section data-timing="45">
                    <h2>NAND flash storage</h2>

                    <ul>
                        <li>Read: read data</li>
                        <li>Write: <span class="fragment">turn off bits (1&#8594;0)</span></li>
                        <li>Erase: <span class="fragment">erase a whole <i>erase-block</i> (0&#8594;1)</span></li>
                    </ul>
                    
                    <p class="fragment">Erase-blocks have a limited <i>program/erase</i> cycles</p>

                    <aside class="notes" data-markdown>
                        - Write applies a mask
                        - Erase block - a megabyte or so
                        - Maybe thousand up to hundred thousand erase cycles
                    </aside>
                </section>-->

                <section data-timing="60">
                    <h2>Flash translation layer - FTL</h2>

                    <p>Firmware is responsible for:</p>
                    <ul>
                        <li>Wear leveling</li>
                        <li>Bad block management</li>
                        <li>eMMC bus communication</li>
                    </ul>

                    <img style="height:280px" src="resources/ftl.png" />

                    <aside class="notes">
                        Flash Translation Layer is also called FTL
                    </aside>
                </section>

                <section data-timing="45">
                    <h2> VTU00M 0<span style="text-transform:none">x</span>F1 bug üêû</h2>

                    <p>FTL has to modify metadata on writes.</p>

                    <div class="align">
                        <p class="fragment">FTL metadata gets corrupted once due to a bug</p>
                        <p class="fragment">&#8658; On each boot, FTL raises a CPU exception</p>
                        <p class="fragment">&#8658; CPU enters an infinite loop</p>
                        <p class="fragment">&#8658; eMMC is essentially dead</p>
                        <p class="fragment">Samsung's patch: Metadata about to get corrupted? Halt CPU!</p>
                    </div>
                </section>

                <section data-background="resources/nospoon.jpg">
                    <div class="stretch" style="-webkit-text-stroke:2px black">
                        <h2>DO NOT TRY TO FIX THE BUG...</h2>
                        <h2 style="position:absolute;bottom:0;text-align:center;width:100%">INSTEAD, REALIZE THERE IS NO BUG</h2>
                    </div>
                </section>

                <!--<section data-markdown>
                    <textarea data-template>
                        ## Recap

                        * Got eMMC FW by analyzing Samsung's patch

                        * eMMC FW has a bug causing FTL corruption

                        * Bug only happens once in a while

                        * Once bug has happened, chip won't boot anymore

                        * Samsung's patch: just before the corruption, halt eMMC
                    </textarea>
                </section>-->

                <section data-markdown>
                    <textarea data-template>
                        ## Outline

                        1. Introduction  <!-- .element class="muted" -->
                        2. Samsung's eMMC patch  <!-- .element class="muted" -->
                        3. Obtain &amp; analyze the firmware  <!-- .element class="muted" -->
                        4. The bug  <!-- .element class="muted" -->
                        5. Resurrect dead phones

                        *Sure... what?!* <!-- .element class="fragment" -->
                    </textarea>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        eMMC gets into a loop at boot.

                        But what happens *before*?
                    </textarea>
                </section>

                <section data-timing="40">
                    <h2>eMMC Memory layout</h2>

                    <img class="plain stretch" src="resources/memory-layout.png" />
                </section>

                <section data-timing="60">
                    <h2>Boot ROM</h2>
                    <p>Initializes hardware and loads firmware *<b>from flash</b>*</p>
                    <p>Has its own machinery for eMMC commands<br/>(when firmware loading fails)</p>
                    <p>Basically a stripped down firmware (no FTL)</p>

                    <aside class="notes">
                        My guess: firmware is too big to reside inside the ARM, so it is saved on flash
                    </aside>
                </section>

                <section data-timing="30">
                    <h2>How S3 works (take 3)</h2>
                    <img class="plain" src="resources/new/schematic_3.svg" />
                </section>

                <section data-timing="30">
                    <p>If only we could talk to the boot ROM...</p>
                    <p>However, firmware loading actually <i>succeeds</i></p>
                    <p>Firmware executes, enters a loop &#8658; no chance</p>
                    <p class="fragment"><i>Right?</i></p>
                </section>

                <section data-timing="60">
                    <h2>Interrupt #7</h2>
                    <p>On boot (<code>sub_7DBC</code>), a timer is being set for 35ms</p>
                    <p>If during this period some interrupt fires - <br/>
                    a value (MMIO) is compared to <code>0x69FF87A9</code></p>
                    <p>In that case - firmware loading is skipped!</p>
                </section>

                <section data-timing="30">
                    <img class="plain stretch" src="resources/emmc_boot.svg" />

                    <aside class="notes" data-markdown>
                        - Normal flow is left column
                        - Goal: go to the right column
                    </aside>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        My guess: some eMMC command with argument 0x69FF87A9
                    </textarea>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        ## Recap

                        * Dead eMMCs get stuck on boot

                        * However, right before, there's a time window

                        * During this window one may interrupt boot

                        * Boot interrupted - eMMC boot ROM recovery mode
                    </textarea>
                </section>

                <section data-timing="20">
                    <h3>Wait, what?</h3>

                    <p>Phone is dead. How do we even talk with the eMMC?</p>
                    <p>Sure, <i>I could've used a hardware mod</i>, however...</p>

                    <aside class="notes">
                        Hardware mod requires desoldering the eMMC chip which I can't do
                    </aside>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        ## Outline

                        1. Introduction  <!-- .element class="muted" -->
                        2. Samsung's eMMC patch  <!-- .element class="muted" -->
                        3. Obtain &amp; analyze the firmware  <!-- .element class="muted" -->
                        4. The bug  <!-- .element class="muted" -->
                        5. Talk to the eMMC through magic?
                        6. eMMC boot ROM access  <!-- .element class="muted" -->
                        7. eMMC repair  <!-- .element class="muted" -->
                        8. Conclusion  <!-- .element class="muted" -->
                    </textarea>
                </section>

                <section>
                    <h2>Recap: If you're lucky, you get this.</h2>
                    <img class="plain stretch" src="resources/s3-booting.png" />
                    <p>But how?</p>
                </section>

                <section data-timing="40">
                    <h2>How S3 works (take 4)</h2>
                    <img class="plain" src="resources/new/schematic_4.svg" />

                    <aside class="notes">
                        Two partitions. Boot holds sboot, User holds Linux, Android, apps and so on.
                    </aside>
                </section>

                <section data-timing="40">
                    <p>A friend had a bricked S3 which *<strong>does load</strong>* sboot</p>
                    <p>eMMC has two partitions: boot and user</p>
                    <p>Only user's metadata was corrupted</p>
                    <p>I suspect this is a common scenario</p>
                </section>

                <section data-timing="30">
                    <h2>How S3 breaks</h2>
                    <img class="plain" src="resources/new/schematic_5.svg" />
                </section>

                <section data-markdown data-timing="20">
                    <textarea data-template>
                        ## Broken boot process

                        Exynos loads sboot from eMMC's boot

                        sboot tries to load Linux

                        eMMC parses user metadata - *boom*
                    </textarea>
                </section>

                <section data-timing="40">
                    <p>sboot has a DFU mode called "download mode"</p>
                    <p>Protocol over USB; Loke &#x27f7; Odin</p>
                    <p>No way of sending low-level eMMC commands</p>
                    <img src="resources/odin.png" width="500px" />

                    <aside class="notes">
                        We want sboot to send low-level eMMC commands but the code isn't there, therefore we must... exploit sboot
                    </aside>
                </section>

                <section data-background="resources/s3-download.png">
                    <h2 style="color:#fd4956">sboot Exploitation</h2>
                </section>

                <section data-timing="60">
                    <h3>Taken from sboot PIT packets handling</h3>
                    <pre class="stretch"><code class="cpp" data-trim data-noescape>
      if (is_dump == 1) {
        int sz, data, part;

        <span class="fragment highlight-red" data-fragment-index="0">part</span> = /* read from USB packet */;
        sz = -500 * part + 0x2000;
        if (sz &gt;= 500)
          sz = 500;
        send_packet(&amp;pit_buf[500 * <span class="fragment highlight-red" data-fragment-index="0">part</span>], sz);
      } else {
        <span class="fragment highlight-red" data-fragment-index="1">sz</span> = /* read from USB packet */;
        reply_packet(pkt_type, 0);
        read_packet(pit_buf, <span class="fragment highlight-red" data-fragment-index="1">sz</span>);
        reply_packet(pkt_type, 0);
      }
                    </code></pre>
                </section>

                <section data-timing="40">
                    <h2>sboot vulnerabilities</h2>
                    <ol>
                        <li>Heap relative read</li>
                        <li>Heap overflow</li>
                    </ol>
                    <p>Eventually found out this is actually <strong>not a 0-day</strong></p>
                    <p>Unpatched for S3, but silently fixed in recent devices</p>
                </section>

                <!--<section data-timing="60">
                    <h2>sboot heap implementation</h2>

                    <p>*All* chunks are saved in circular doubly-linked list</p>
                    <p>Choose first best fit</p>
                    <p>Split large chunks <strong>from the end</strong></p>
                    <p>No security mitigations at all :-)</p>
                </section>

                <section data-timing="120">
                    <div style="position:fixed;top:10%" class="fragment">malloc(0x50)</div>
                    <div style="position:relative;display:inline-block">
                        <img class="plain" src="resources/sboot_heap.svg" />
                        <svg height="100" width="100" class="fragment current-visible" style="position:absolute;top:2%;left:34%;">
                            <circle cx="50" cy="50" r="20" stroke="black" stroke-width="3" fill="#1b91ff" />
                        </svg>
                        <svg height="100" width="100" class="fragment current-visible" style="position:absolute;top:22%;left:68%;">
                            <circle cx="50" cy="50" r="20" stroke="black" stroke-width="3" fill="#1b91ff" />
                        </svg>
                        <svg height="100" width="100" class="fragment current-visible" style="position:absolute;top:51%;left:68%;">
                            <circle cx="50" cy="50" r="20" stroke="black" stroke-width="3" fill="#1b91ff" />
                        </svg>
                        <svg height="100" width="100" class="fragment current-visible" style="position:absolute;top:73%;left:34%;">
                            <circle cx="50" cy="50" r="20" stroke="black" stroke-width="3" fill="#1b91ff" />
                        </svg>
                        <svg height="100" width="100" class="fragment current-visible" style="position:absolute;top:51%;left:1%;">
                            <circle cx="50" cy="50" r="20" stroke="black" stroke-width="3" fill="#1b91ff" />
                        </svg>
                        <svg height="100" width="100" class="fragment current-visible" style="position:absolute;top:22%;left:1%;">
                            <circle cx="50" cy="50" r="20" stroke="black" stroke-width="3" fill="#1b91ff" />
                        </svg>
                        <svg height="100" width="100" class="fragment current-visible" style="position:absolute;top:2%;left:34%;">
                            <circle cx="50" cy="50" r="20" stroke="black" stroke-width="3" fill="#1b91ff" />
                        </svg>
                        <svg width="200" height="100" class="fragment" style="position:absolute;top:29.5%;left:67%">
                            <rect width="200" height="100" style="fill:transparent;stroke-width:20;stroke:#1b91ff" />
                        </svg>
                    </div>
                </section>

                <section data-timing="20">
                    <img class="plain" src="resources/sboot_heap_2.svg" />
                </section>

                <section data-timing="20">
                    <img class="plain" src="resources/sboot_heap_3.svg" style="padding-right:109px" />
                </section>

                <section data-timing="120">
                    <h3>Exploitation strategy</h3>

                    <p class="align"><u>Goal</u>: achieve write-what-where<br />
                        <u>Means</u>: exploit chunk splitting</p>

                    <ol class="align">
                        <li>Fake a chunk header with *<strong>large</strong>* size</li>
                        <li>Figure out its address</li>
                        <li>Make sure this chunk is selected upon <code>malloc(sz)</code></li>
                        <li class="fragment">Returns <code><span style="color:#ff2c2d">addr</span> = chunk + <span style="color:#1b91ff">chunk-&gt;size</span> - sz</code></li>
                        <li class="fragment">Set <code><span style="color:#1b91ff">chunk-&gt;size</span> = <span style="color:#ff2c2d">addr</span> - chunk + sz</code></li>
                    </ol>
                </section>

                <section>
                    <h2>Exploitation example</h2>
                    <ul>
                        <li>Fake chunk is at address <code>0x1337000</code></li>
                        <li>We want to write <code>0xDEADBEEF</code></li>
                        <li><code>malloc(0x100)</code> is called</li>
                        <li class="fragment">Set <code>size = 0xDEADBEEF-0x13370000+0x100</code></li>
                        <li class="fragment"><code>malloc(0x100)</code> returns<br /><code>0x13370000 + size - 0x100<br /><span class="fragment">= 0xDEADBEEF</span></code></li>
                    </ul>
                </section>-->

                <section data-markdown>
                    <textarea data-template>
                        ## Details are boring

                        Exploit is available in the project repository

                        https://github.com/oranav/i9300_emmc_toolbox
                    </textarea>
                </section>

                <section data-background-video="resources/exploit.webm" data-background-size="contain" data-background-video-muted="true">
                </section>

                <section data-background="resources/s3-black.png" data-background-size="contain">
                    <h2>But what if it's <u>really</u> dead?</h2>
                </section>

                <section>
                    <h2>How S3 utterly breaks</h2>
                    <img class="plain" src="resources/new/schematic_6.svg" />

                    <aside class="notes">
                        Something obviously must load sboot... what is it?
                    </aside>
                </section>

                <section data-timing="30">
                    <h2>How S3 almost breaks</h2>
                    <img class="plain" src="resources/new/schematic_7.svg" />
                </section>

                <section data-markdown data-timing="40">
                    <textarea data-template>
                        ## Exynos boot process

                        1. Exynos boot ROM
                        2. 1bl (eMMC boot)
                        3. sboot (eMMC boot)
                        4. Kernel (eMMC user)

                        <aside class="notes">
                            1bl is prepended to sboot, and should bootstrap it<br />
                            Where does Exynos boot ROM look for 1bl+sboot?
                        </aside>
                    </textarea>
                </section>

                <section data-markdown data-timing="20">
                    <textarea data-template>
                        ## Loading order

                        1. eMMC
                        2. External SD card
                        3. UART
                    </textarea>
                </section>

                <!--<section data-timing="60">
                    <h2>Booting from SD card</h2>
                    <div class="align">
                        <p>sboot boots into <i>"SDCARD mode"</i> - no USB :-(</p>
                        <p>ODROID-X: same CPU, but 1bl happily loads anything!</p>
                        <p>Patch sboot and exploit it over USB :-)</p>
                    </div>

                    <p><small>
                        <a href="https://forum.xda-developers.com/galaxy-s3/general/totally-revolutionary-sdcard-bootloader-t2061437">Totally Revolutionary SDCard Bootloader For Galaxy S III</a><br />
                        <a href="https://forum.xda-developers.com/showthread.php?t=2023069">UnBrickable SD necromancy- Totally restore your device.</a><br />
                        <a href="https://github.com/dmarszk/exynos4_uboot">https://github.com/dmarszk/exynos4_uboot</a><br />
                        <i>AdamOutler, Rebellos, Ralekdev</i>
                    </small></p>
                </section>-->

                <section data-markdown data-timing="30">
                    <textarea data-template>
                        ## Modified boot process

                        1. Exynos boot ROM
                        2. 1bl (SD card)
                        3. sboot (SD card)
                        4. Shellcode via USB
                        
                        **No hardware mod required!**
                    </textarea>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        ## Recap

                        * Boot partition still intact &#8658; phone loads sboot

                        * Boot partition corrupt &#8658; phone uses SD card

                        * Either way load sboot

                        * Exploit a vulnerability to gain code execution
                    </textarea>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        ## Outline

                        1. Introduction  <!-- .element class="muted" -->
                        2. Samsung's eMMC patch  <!-- .element class="muted" -->
                        3. Obtain &amp; analyze the firmware  <!-- .element class="muted" -->
                        4. The bug  <!-- .element class="muted" -->
                        5. sboot Exploitation  <!-- .element class="muted" -->
                        6. eMMC boot ROM access
                        7. eMMC repair  <!-- .element class="muted" -->
                        8. Conclusion  <!-- .element class="muted" -->
                    </textarea>
                </section>

                <section data-markdown data-timing="20">
                    <textarea data-template>
                        Got code execution on Exynos either way

                        Let's try and talk to eMMC's boot ROM

                        Remember? 0x69FF87A9...
                    </textarea>
                </section>

                <section data-timing="60">
                    <h3>Repeat for x: (0 ... 63)</h3>
                    <ol>
                        <li>Power off eMMC</li>
                        <li class="fragment">Power on eMMC</li>
                        <li class="fragment">Quickly send CMDx with arg <code>0x69FF87A9</code></li>
                        <li class="fragment">Wait 200ms</li>
                        <li class="fragment">Send any command supported by boot ROM</li>
                        <li class="fragment">Check if you get a response</li>
                    </ol>

                    <div class="align">
                        <p class="fragment"><span style="color:#ff2c2d">&#x2717;</span> CMD0(0x69FF87A9) fails</p>
                        <p class="fragment"><span style="color:#17ff2e">&#x2713;</span> CMD1(0x69FF87A9) works!</p>
                    </div>

                    <aside class="notes">
                        Let's find out which command it is. Iterate over all commands (x)
                    <aside>
                </section>

                <section data-markdown data-timing="20">
                    <textarea data-template>
                        eMMC responds for the first time! ‚úå

                        eMMC boot ROM even has CMD62

                        Let's fix it once and for all

                        <aside class="notes">
                            This is <u>the first time</u> the eMMC ever responded in my device; up until now, I sent commands but seen no response.
                        </aside>
                    </textarea>
                </section>

                <section data-background="resources/repair.jpg">
                    <h1 style="color:#fd4956"><span style="text-transform:none;">e</span>MMC repairing</h1>
                </section>

                <section data-timing="60">
                    <h2>New firmware</h2>
                    <p>There are two revisions of VTU00M:</p>
                    <ul>
                        <li>Firmware 0xf1 - buggy</li>
                        <li>Firmware 0xf7 - bug is fixed</li>
                    </ul>

                    <p><strong>Goal:</strong> Update chip to 0xf7 and format FTL metadata</p>
                </section>

                <section data-markdown data-timing="30">
                    <textarea data-template>
                        ## f7 dump

                        eMMC firmware dump tool - kernel module

                        Convince anyone to run your code on their device...

                        Got a dump from @artesea at XDA-Developers!
                    </textarea>
                </section>

                <section data-markdown data-timing="30">
                    <textarea data-template>
                        ## eMMC firmware upgrade

                        Absolutely doable:

                        Use backdoor to write RAM and run your code

                        However, there's another, simpler way... <!-- .element: class="fragment" -->
                    </textarea>
                </section>

                <section data-markdown data-timing="60">
                    <textarea data-template>
                        ## CMD60 firmware upgrade

                        Another backdoor - CMD60(0xefac60ec)

                        Two firmware upgrade modes:
                        1. CMD60(0xcbad1160)
                        2. CMD60(0x1bfc3360)

                        Former supports FTL metadata format!
                    </textarea>
                </section>

                <section data-markdown data-timing="60">
                    <textarea data-template>
                        ## Wrap-up

                        1. Get a dead Galaxy S3 (GT-I9300)
                        2. Boot to sboot (directly or SD card)
                        3. Exploit sboot
                        4. Reboot eMMC into boot ROM recovery mode
                        5. Use CMD60 to format FTL and flash 0xf7
                        6. Reboot eMMC
                        7. Write sboot to eMMC's boot partition
                        8. ???  <!-- .element class="fragment" data-fragment-index="0" -->
                        9. PROFIT  <!-- .element class="fragment" data-fragment-index="0" -->

                        <aside class="notes">
                            And the last step is to profit, which obviously means... it's demo time
                        </aside>
                    </textarea>
                </section>

                <section data-markdown data-background-color="#360b00" data-timing="240">
                    <textarea data-template>
                        # Demo time
                    </textarea>
                </section>

                <section data-markdown>
                    <textarea data-template>
                        ## Outline

                        1. Introduction  <!-- .element class="muted" -->
                        2. Samsung's eMMC patch  <!-- .element class="muted" -->
                        3. Obtain &amp; analyze the firmware  <!-- .element class="muted" -->
                        4. The bug  <!-- .element class="muted" -->
                        5. sboot Exploitation  <!-- .element class="muted" -->
                        6. eMMC boot ROM access  <!-- .element class="muted" -->
                        7. eMMC repair  <!-- .element class="muted" -->
                        8. Conclusion
                    </textarea>
                </section>

                <section data-timing="30">
                    <h2>New eMMCs and where to find them</h2>

                    <p>Go over pictures of chinese development boards...</p>

                    <div style="position:relative;display:inline-block">
                        <img src="resources/orangepiplus2e.jpg" height="400" class="fragment" />
                        <svg width="70" height="50" class="fragment" style="position:absolute;top:47%;left:47%;transform:rotate(119deg)">
                            <rect width="70" height="50" style="fill:transparent;stroke-width:10;stroke:#fd4956" />
                        </svg>
                    </div>
                </section>

                <section data-timing="40" data-markdown>
                    <textarea data-template>
                        ## New firmware

                        * CMD62(0x10210002) works!

                        * Got the firmware

                        * Some function calls just don't make sense...

                            Jump to the middle of a function?
                    </textarea>
                </section>

                <section data-timing="30" data-markdown>
                    <textarea data-template>
                        ## OVL function

                        * Weird function calls are to high addresses

                        * Before each such call, there's another function

                        * The preceding function is always the same

                        * The preceding function uses constants:
                            * 'OVL0', 'OVL1', 'OVL2', 'OVL3'
                    </textarea>
                </section>

                <section data-timing="60" data-markdown>
                    <textarea data-template>
                        ## Overlay mechanism

                        Not enough ARM RAM to hold the firmware

                        Some functions are stored in a *memory overlay*

                        Before each call to such function, the correct overlay is loaded from the NAND...

                        Work in progress
                    </textarea>
                </section>

                <section data-markdown data-timing="30">
                    <textarea data-template>
                        ## Further research

                        * New eMMC / UFS devices
                        * Restore data (FTL metadata parser)
                        * Open-source alternative firmware
                    </textarea>
                </section>

                <section data-markdown data-timing="40">
                    <textarea data-template>
                        ## Conclusion

                        * Can pwn Samsung eMMCs

                        * Can fix bricked S3 with software

                        * However, this is just a use case...

                        * Newer eMMCs - probably still suspectible
                    </textarea>
                </section>

                <section data-markdown data-timing="40">
                    <textarea data-template>
                        ## Shout outs

                        * Rebellos, AdamOutler, Ralekdev - Exynos U-Boot and 1bl work

                        * Entropy512 - Involved in eMMC research in 2013

                        * bunnie &amp; xobs - wonderful 30C3 talk about hacking chinese SD cards
                            * And for motivating me to complete this research!
                    </textarea>
                </section>

                <!--
                <section data-markdown data-background-color="#003626" data-timing="900">
                    <textarea data-template>
                        ## Questions &amp; Code 

                        * sboot exploit &amp; shellcode

                            https://github.com/oranav/i9300_emmc_toolbox
                        * Python Samsung eMMC sandbox

                            https://github.com/oranav/movipwn
                        * Slides

                            https://github.com/oranav/emmc-talk-2017
                    </textarea>
                -->

                <section data-markdown data-background-color="#003626" data-timing="300">
                    <textarea data-template>
                        ## Questions &amp; Code

                        * sboot exploit, shellcode &amp; eMMC related stuff

                            https://github.com/oranav/i9300_emmc_toolbox
                        * Slides

                            https://github.com/oranav/emmc-talk-2017

                        * Samsung eMMC Python tool (will be released later)

                            https://github.com/oranav/movipwn
                    </textarea>
                </section>
                </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
                ],
                history: true,
                transition: 'fade',
                transitionSpeed: 'fast',
                defaultTiming: 10,
			});
		</script>
	</body>
</html>
